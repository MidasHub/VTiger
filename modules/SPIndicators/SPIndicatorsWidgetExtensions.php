<?php
class SPIndicatorsWidgetExtensions_CheckDuplicate_Action extends Vtiger_Action_Controller { public function checkPermission(Vtiger_Request $spe45a8b) { return; } public function process(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $specf7c8 = $spe45a8b->get('record'); if ($specf7c8) { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); } else { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getCleanInstance($spf04718); } $spd00410->set('id', $specf7c8); $spd00410->set('name', $spe45a8b->get('name')); $spd00410->set('isDuplicate', $spe45a8b->get('iresDuplicate')); $spda7f19 = array('success' => false); if ($spd00410->checkDuplicate()) { $spda7f19 = array('success' => true, 'message' => vtranslate('LBL_RECORD_WITH_NAME_EXISTS', $spf04718)); } $sp9f77c8 = new Vtiger_Response(); $sp9f77c8->setResult($spda7f19); $sp9f77c8->emit(); } } class SPIndicatorsWidgetExtensions_DeleteAjax_Action extends Vtiger_Delete_Action { public function checkPermission(Vtiger_Request $spe45a8b) { $spaa2ece = $spe45a8b->get('record'); $spf04718 = $spe45a8b->getModule(); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($spaa2ece, $spf04718); if ($spd00410 != null && !$spd00410->isDeletable()) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } return true; } public function process(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $spaa2ece = $spe45a8b->get('record'); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($spaa2ece, $spf04718); $spd00410->delete(); $sp771dcc = $spe45a8b->get('viewname'); $sp9f77c8 = new Vtiger_Response(); $sp9f77c8->setResult(array('viewname' => $sp771dcc, 'module' => $spf04718)); $sp9f77c8->emit(); } } class SPIndicatorsWidgetExtensions_MassDelete_Action extends Vtiger_Mass_Action { public function checkPermission(Vtiger_Request $spe45a8b) { return; } public function process(Vtiger_Request $spe45a8b) { $spce0704 = array(); $spd22f8c = Vtiger_Module_Model::getInstance($spe45a8b->getModule()); $sp00b17c = $spd22f8c->getMassActionRecords($spe45a8b->get('selected_ids')); foreach ($sp00b17c as $spd00410) { if ($spd00410->isDeletable()) { $spd00410->delete(); } else { $spce0704[] = $spd00410->getName(); } } $spf04718 = $spe45a8b->getModule(); $sp9f77c8 = new Vtiger_Response(); if (empty($spce0704)) { $sp9f77c8->setResult(array(vtranslate('LBL_RECORDS_DELETED_SUCCESSFULLY', $spf04718))); } else { $sp9f77c8->setError($spce0704, vtranslate('LBL_DENIED_DELETE_RECORDS', $spf04718)); } $sp9f77c8->emit(); } } class SPIndicatorsWidgetExtensions_Save_Action extends Vtiger_Save_Action { public function checkPermission(Vtiger_Request $spe45a8b) { SPIndicatorsWidgetExtensions_Module_Model::checkViewRecordAccess($spe45a8b); } public function process(Vtiger_Request $spe45a8b) { $specf7c8 = $spe45a8b->get('record'); $spf04718 = $spe45a8b->getModule(); $spcb6559 = SPIndicatorsWidgetExtensions_Record_Model::getCleanInstance($spf04718); if (!empty($specf7c8) && !$spe45a8b->get('isDuplicate')) { $spcb6559->setId($specf7c8); } foreach ($spcb6559->getSaveFieldsNames() as $sp49181f) { $spcb6559->set($sp49181f, $spe45a8b->get($sp49181f)); } $spcb6559->save(); $sp6ad0ba = $spcb6559->getDetailViewUrl(); header("Location: {$sp6ad0ba}"); } } abstract class SPIndicatorsWidgetExtensions_SPIndicatorsWidgetExtensions_Dashboard extends Vtiger_IndexAjax_View { public function process(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $spaa2ece = $spe45a8b->get('record'); $sp5e5c2c = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($spaa2ece, $spf04718); $sp4e5b59 = $sp5e5c2c->getBindedWidgetModel(); $sp86de9e = new SPIndicatorsWidgetExtensionsPlotParams(); $sp2dc6df = $spe45a8b->get('content'); $sp060acf = $spe45a8b->get('isReportView'); $sp86de9e->parsePlotParams($spe45a8b); $spedada1 = $this->getViewer($spe45a8b); $spedada1->assign('WIDGET', $sp4e5b59); $spedada1->assign('MODULE_NAME', $spf04718); try { $spedada1->assign('DATA', $sp5e5c2c->getData($sp86de9e)); } catch (Exception $sp9a71f7) { $spedada1->assign('DATA', null); $spedada1->assign('DATA_ERROR', true); ob_clean(); } $spedada1->assign('CALCULATE_MEMBERS', $sp5e5c2c->getCalculateMembers()); $spedada1->assign('STYLES', $this->getAdditionalStyles($spe45a8b)); $spedada1->assign('SCRIPTS', $this->getAdditionalScripts()); $spedada1->assign('CURRENTUSER', Users_Record_Model::getCurrentUserModel()); $spedada1->assign('DEFAULT_ASSIGNED_USER_FILTER', SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_ASSIGNED_USER_FILTER); $spedada1->assign('IS_REPORT_VIEW', $sp060acf); if ($sp060acf) { $sp5e5c2c->applyReportViewModeToWidget($sp4e5b59); if (!empty($sp2dc6df)) { $spedada1->view($this->getReportViewWidgetContentsTPL(), $spf04718); } else { $spedada1->view($this->getReportViewWidgetTPL(), $spf04718); } } else { if (!empty($sp2dc6df)) { $spedada1->view($this->getDashBoardWidgetContentsTPL(), $spf04718); } else { $spedada1->view($this->getDashBoardWidgetTPL(), $spf04718); } } } protected abstract function getAdditionalScripts(); protected abstract function getReportViewWidgetTPL(); protected abstract function getReportViewWidgetContentsTPL(); protected abstract function getDashBoardWidgetTPL(); protected function getDashBoardWidgetContentsTPL() { return 'dashboards/DashBoardWidgetContents.tpl'; } protected function getAdditionalStyles(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); global $default_layout; $sp30c216 = $this->checkAndConvertCssStyles(array("~/layouts/{$default_layout}/modules/{$spf04718}/resources/css/SPIndicatorsWidgetExtensionsDashboard.css")); return array_merge($sp30c216); } } class SPIndicatorsWidgetExtensions_DetailView_Model extends Vtiger_DetailView_Model { public static function getInstance($spf04718, $spaa2ece) { $spc42de6 = Vtiger_Loader::getComponentClassName('Model', 'DetailView', $spf04718); $sp757611 = new $spc42de6(); $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($spaa2ece, $spf04718); return $sp757611->setModule($spd22f8c)->setRecord($spd00410); } public function getDetailBasicLinks() { $sp450fba = array(); $sp450fba[] = Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'LISTVIEWBASIC', 'linklabel' => 'LBL_ADD_RECORD', 'linkurl' => $this->getModule()->getCreateRecordUrl(), 'linkicon' => 'fa-plus')); return $sp450fba; } public function getDetailViewLinks($sp9c4c72 = '') { $spd00410 = $this->getRecord(); $spd57ebc = array(); $spa6b2fa = array('linktype' => 'DETAILVIEWBASIC', 'linklabel' => 'LBL_EDIT', 'linkurl' => $spd00410->getEditViewUrl(), 'linkicon' => ''); $spd57ebc['DETAILVIEWBASIC'][] = Vtiger_Link_Model::getInstanceFromValues($spa6b2fa); $spe0ef90 = array('linktype' => 'DETAILVIEWBASIC', 'linklabel' => 'LBL_DUPLICATE', 'linkurl' => $spd00410->getDuplicateRecordUrl(), 'linkicon' => ''); $spd57ebc['DETAILVIEWBASIC'][] = Vtiger_Link_Model::getInstanceFromValues($spe0ef90); return $spd57ebc; } public function getWidgets() { return array(); } } class SPIndicatorsWidgetExtensions_ListView_Model extends Vtiger_ListView_Model { public static function getInstance($spf04718) { $spc42de6 = Vtiger_Loader::getComponentClassName('Model', 'ListView', $spf04718); $sp757611 = new $spc42de6(); $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); return $sp757611->set('module', $spd22f8c); } public function getListViewLinks() { $sp1d077d = $this->getBasicLinks(); foreach ($sp1d077d as $sp07ec3d) { $sp450fba['LISTVIEWBASIC'][] = Vtiger_Link_Model::getInstanceFromValues($sp07ec3d); } return $sp450fba; } public function getListBasicLinks() { $sp450fba = array(); $sp450fba[] = Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'LISTVIEWBASIC', 'linklabel' => 'LBL_ADD_RECORD', 'linkurl' => $this->getModule()->getCreateRecordUrl(), 'linkicon' => 'fa-plus')); return $sp450fba; } public function getListViewMassActions($sp9c4c72) { $spd22f8c = $this->getModule(); $sp450fba = array(); $sp450fba['LISTVIEWMASSACTION'][] = Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'LISTVIEWMASSACTION', 'linklabel' => 'LBL_DELETE', 'linkurl' => 'javascript:Vtiger_List_Js.massDeleteRecords("index.php?module=' . $spd22f8c->get('name') . '&action=MassDelete");', 'linkicon' => '')); return $sp450fba; } public function getListViewHeaders() { $spfec9c6 = array(); $spc98ace = array('Name' => 'name', 'Description' => 'description'); foreach ($spc98ace as $sp6c5a37 => $sp49181f) { $sp07a76a = new Vtiger_Field_Model(); $sp07a76a->set('name', $sp49181f); $sp07a76a->set('label', $sp6c5a37); $sp07a76a->set('column', $sp49181f); $spfec9c6[] = $sp07a76a; } return $spfec9c6; } public function getListViewEntries($sp5e6ed4) { $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query($this->spedbebd($sp5e6ed4)); $sp999d0e = $spe6c55d->num_rows($spda7f19); $sp199381 = array(); for ($sp3deaa8 = 0; $sp3deaa8 < $sp999d0e; $sp3deaa8++) { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getCleanInstance($this->getModule()->getName()); $spd00410->setData($spe6c55d->query_result_rowdata($spda7f19, $sp3deaa8)); $sp199381[$spd00410->getId()] = $spd00410; } $sp5e6ed4->calculatePageRange($sp199381); if ($sp999d0e > $sp5e6ed4->getPageLimit()) { array_pop($sp199381); $sp5e6ed4->set('nextPageExists', true); } else { $sp5e6ed4->set('nextPageExists', false); } return $sp199381; } public function getListViewCount() { $spab36f6 = 'SELECT count(*) AS count FROM ' . $this->getModule()->getMainTableName(); $spab36f6 .= $this->spef2f89(); $spe6c55d = PearDatabase::getInstance(); $sp07a73a = $spe6c55d->query($spab36f6); return $spe6c55d->query_result($sp07a73a, 0, 'count'); } private function spedbebd($sp5e6ed4) { $spab36f6 = 'SELECT * FROM ' . $this->getModule()->getMainTableName(); $spa02855 = $sp5e6ed4->getStartIndex(); $sp163a3b = $sp5e6ed4->getPageLimit(); $sp114a15 = $this->getForSql('orderby'); $spd41ab7 = $this->getForSql('sortorder'); $spab36f6 .= $this->spef2f89(); if (!empty($sp114a15) && $sp114a15 === 'smownerid') { $sp07a76a = Vtiger_Field_Model::getInstance('assigned_user_id'); if ($sp07a76a->getFieldDataType() == 'owner') { $sp114a15 = 'COALESCE(CONCAT(vtiger_users.first_name, vtiger_users.last_name), vtiger_groups.groupname)'; } } if ($sp114a15) { $spab36f6 .= " ORDER BY {$sp114a15} {$spd41ab7}"; } $spab36f6 .= " LIMIT {$spa02855}," . ($sp163a3b + 1); return $spab36f6; } private function spef2f89() { $spf40403 = ''; $sp28e428 = $this->get('search_key'); $spdec572 = $this->get('search_value'); $sp2acbec = Users_Record_Model::getCurrentUserModel(); if ($sp2acbec->isAdminUser()) { if (!empty($sp28e428) && !empty($spdec572)) { $spf40403 .= " WHERE {$sp28e428} LIKE '{$spdec572}%'"; } } else { $sp80c662 = array_keys($sp2acbec->getSubordinateUsers()); $sp80c662[] = $sp2acbec->getId(); $spf40403 .= ' WHERE owner IN (' . join(',', $sp80c662) . ')'; if (!empty($sp28e428) && !empty($spdec572)) { $spf40403 .= " AND {$sp28e428} LIKE '{$spdec572}%'"; } } return $spf40403; } } abstract class SPIndicatorsWidgetExtensions_Module_Model extends Vtiger_Module_Model { public function isCustomizable() { return false; } public function isFilterColumnEnabled() { return false; } public function getAlphabetSearchField() { return 'name'; } public function getSideBarLinks($sp9c4c72) { $sp450fba = array(); $sp450fba['SIDEBARLINK'][] = Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'SIDEBARLINK', 'linklabel' => 'LBL_RECORDS_LIST', 'linkurl' => $this->getListViewUrl(), 'linkicon' => '')); return $sp450fba; } public function getMassActionRecords($sp99e2ea) { $sp466950 = array(); if (!empty($sp99e2ea)) { if ($sp99e2ea == 'all') { $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query('SELECT id FROM ' . $this->getMainTableName()); while ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { $sp466950[] = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($sp061318['id'], $this->getName()); } } else { foreach ($sp99e2ea as $spaa2ece) { $sp466950[] = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($spaa2ece, $this->getName()); } } } return $sp466950; } public static function getRecordsCount() { $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query('select count(*) AS totalrecords FROM ' . $this->getMainTableName()); $sp061318 = $spe6c55d->fetchByAssoc($spda7f19); return $sp061318['totalrecords']; } public function deleteRecord($spd00410) { $spe6c55d = PearDatabase::getInstance(); $spe6c55d->pquery('DELETE FROM ' . $this->getMainTableName() . ' WHERE id = ?', array($spd00410->getId())); $spe6c55d->pquery('DELETE FROM ' . $this->getReportsStagesTableName() . ' WHERE record_id = ?', array($spd00410->getId())); $spb40b8d = $spd00410->findWidgetLinkModel(); if ($spb40b8d != null) { $spe6c55d->pquery('DELETE FROM vtiger_module_dashboard_widgets WHERE linkid=?', $spb40b8d->getId()); $spd00410->removeWidgetLink(); } } public function isQuickSearchEnabled() { return false; } public static function checkViewRecordAccess($spe45a8b) { $sp8ffed9 = Users_Privileges_Model::getCurrentUserPrivilegesModel(); $spd22f8c = Vtiger_Module_Model::getInstance('Reports'); if (!$sp8ffed9->hasModulePermission($spd22f8c->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } $spf04718 = $spe45a8b->getModule(); $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); if (!$sp8ffed9->hasModulePermission($spd22f8c->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } $specf7c8 = $spe45a8b->get('record'); if ($specf7c8) { SPIndicatorsWidgetExtensions_Module_Model::checkRecordForAction($specf7c8, $spf04718); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); if (!$spd00410->isEditable()) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } } public static function checkRecordForAction($specf7c8, $spf04718) { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); if ($spd00410 == null) { throw new AppException(vtranslate('LBL_RECORD_NOT_FOUND')); } } public abstract function getMainTableName(); public abstract function getReportsStagesTableName(); } class SPIndicatorsWidgetExtensions_Record_Model extends Vtiger_Record_Model { const LINKS_DASHBOARD_VIEW_TYPE = 'DASHBOARDWIDGET'; private $indicatorPlotParams; public function getCalculateMembers() { $sp4fadf7 = array(); $sp02b4e5 = $this->spc34446(); foreach ($sp02b4e5 as $sp392b5a) { list($sp42382a, $sp84043a) = explode(':', $sp392b5a, 2); if (!array_key_exists($sp42382a, $sp4fadf7)) { $sp4fadf7[$sp42382a] = array(); } $sp93aa12 = null; if ($sp42382a === Settings_Groups_Member_Model::MEMBER_TYPE_USERS) { $sp93aa12 = Users_Record_Model::getInstanceById($sp84043a, 'Users'); } else { if ($sp42382a === Settings_Groups_Member_Model::MEMBER_TYPE_GROUPS) { $sp93aa12 = Settings_Groups_Record_Model::getInstance($sp84043a); } } if ($sp93aa12 != null && $sp93aa12->getId() != null) { $sp67074e = Settings_Groups_Member_Model::getQualifiedId($sp42382a, $sp84043a); $spfc3116 = new Settings_Groups_Member_Model(); $spfc3116->set('id', $sp67074e)->set('name', $sp93aa12->getName()); $sp4fadf7[$sp42382a][$sp67074e] = $spfc3116; } } return $sp4fadf7; } public static function getAllCalculateMembers() { $sp4fadf7 = array(); $sp540dd0 = Users_Record_Model::getAll(true); foreach ($sp540dd0 as $sp42e2ba => $spc6dc3d) { $sp67074e = Settings_Groups_Member_Model::getQualifiedId(Settings_Groups_Member_Model::MEMBER_TYPE_USERS, $sp42e2ba); $spfc3116 = new Settings_Groups_Member_Model(); $sp4fadf7[Settings_Groups_Member_Model::MEMBER_TYPE_USERS][$sp67074e] = $spfc3116->set('id', $sp67074e)->set('name', $spc6dc3d->getName()); } $spb656d1 = Settings_Groups_Record_Model::getAll(); foreach ($spb656d1 as $sp3183c0 => $spdb57a3) { $sp67074e = Settings_Groups_Member_Model::getQualifiedId(Settings_Groups_Member_Model::MEMBER_TYPE_GROUPS, $sp3183c0); $spfc3116 = new Settings_Groups_Member_Model(); $sp4fadf7[Settings_Groups_Member_Model::MEMBER_TYPE_GROUPS][$sp67074e] = $spfc3116->set('id', $sp67074e)->set('name', $spdb57a3->getName()); } $spfc3116 = new Settings_Groups_Member_Model(); $sp4fadf7[Settings_Groups_Member_Model::MEMBER_TYPE_ROLE_AND_SUBORDINATES][0] = $spfc3116->set('id', 1)->set('name', vtranslate('All users', 'SPIndicators')); return $sp4fadf7; } public function getSaveFieldsNames() { return array('name', 'description', 'report_ids', 'reports_plot_by'); } public function getName() { return $this->get('name'); } public static function getInstanceById($spaa2ece, $spf04718) { $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->pquery('SELECT * FROM ' . $spd22f8c->getMainTableName() . ' WHERE id=?', array($spaa2ece)); $spd00410 = null; if ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { if (!array_key_exists('label', $sp061318)) { $sp061318['label'] = $sp061318['name']; } $spc42de6 = Vtiger_Loader::getComponentClassName('Model', 'Record', $spf04718); $spd00410 = new $spc42de6(); $spd00410->setData($sp061318); $spd00410->setModuleFromInstance($spd22f8c); } return $spd00410; } public static function getAll($spf04718) { $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query('SELECT * FROM ' . $spd22f8c->getMainTableName()); $spb930c0 = array(); while ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { $spc42de6 = Vtiger_Loader::getComponentClassName('Model', 'Record', $spf04718); $spd00410 = new $spc42de6(); $spd00410->setData($sp061318); $spd00410->setModuleFromInstance($spd22f8c); $spb930c0[] = $spd00410; } return $spb930c0; } public function save() { $spe6c55d = PearDatabase::getInstance(); $sp2acbec = Users_Record_Model::getCurrentUserModel(); $spd22f8c = $this->getModule(); if ($this->getId() == null) { $this->setId($spe6c55d->getUniqueID($spd22f8c->getMainTableName())); $spe6c55d->pquery('INSERT INTO ' . $spd22f8c->getMainTableName() . ' VALUES(?,?,?,?)', array($this->getId(), $this->get('name'), $this->get('description'), $sp2acbec->getId())); $this->sp8fb7c1(); } else { $this->sp8fb7c1(); $spe6c55d->pquery('UPDATE ' . $spd22f8c->getMainTableName() . ' SET name=?, description=? WHERE id=?', array($this->get('name'), $this->get('description'), $this->getId())); } $this->savePlotReports(); $this->spfc6807(); } protected function savePlotReports() { $spe6c55d = PearDatabase::getInstance(); $spd22f8c = $this->getModule(); $spe6c55d->pquery('DELETE FROM ' . $spd22f8c->getReportsStagesTableName() . ' WHERE record_id=?', array($this->getId())); $spc7f166 = $this->get('reports_plot_by'); $spbef09d = $this->get('report_ids'); if (!empty($spbef09d)) { $sp4e55db = array(); $spb446c6 = 'INSERT INTO ' . $spd22f8c->getReportsStagesTableName() . ' VALUES'; foreach ($spbef09d as $sp1aacd6 => $sp5127d4) { $spb446c6 .= '(?,?,?,?),'; $sp4e55db[] = $this->getId(); $sp4e55db[] = $sp5127d4; $sp4e55db[] = $spc7f166[$sp5127d4]; $sp4e55db[] = $sp1aacd6; } $spe6c55d->pquery(substr($spb446c6, 0, -1), $sp4e55db); } } public function getIndicatorsList() { $spe6c55d = PearDatabase::getInstance(); $spd22f8c = $this->getModule(); $sp04df82 = array(); $spda7f19 = $spe6c55d->pquery('SELECT * FROM ' . $spd22f8c->getReportsStagesTableName() . ' WHERE record_id=? ORDER BY sequence', array($this->getId())); while ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { $spc2a031 = new SPIndicatorModel($sp061318); $sp04df82[] = $spc2a031; } return $sp04df82; } private function spfc6807() { $sp44e263 = json_encode($this->get('members')); if ($sp44e263 == null) { $sp44e263 = json_encode(array()); } $spe6c55d = PearDatabase::getInstance(); $spe6c55d->pquery('DELETE FROM vtiger_sp_indicators_calculate_members WHERE record_id=?', array($this->getId())); $spe6c55d->pquery('INSERT INTO vtiger_sp_indicators_calculate_members VALUES(?,?)', array($this->getId(), $sp44e263)); } private function spc34446() { $sp852e14 = array(); if ($this->getId() != null) { $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->pquery('SELECT members FROM vtiger_sp_indicators_calculate_members WHERE record_id=?', array($this->getId())); if ($spefc480 = $spe6c55d->fetchByAssoc($spda7f19, -1, false)) { $sp852e14 = json_decode($spefc480['members']); } } return $sp852e14; } private function sp0db4bf($sp8a1b1b) { $spbe0322 = array(); $spbe0322[] = new SPReportCalculationType($sp8a1b1b, SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_PLOT_BY, SPIndicatorsWidgetExtensionsPlotParams::translateReportAggregationKey(SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_PLOT_BY)); $spb9703c = $sp8a1b1b->getSelectedCalculationFields(); foreach ($sp8a1b1b->getCalculationFields() as $spf04718 => $sp729184) { foreach ($sp729184 as $sp909bb0 => $spd2e5ec) { $sp8bd1c8 = explode(':', $sp909bb0); $sp07a554 = $sp8bd1c8[0]; $spca87f2 = $sp8bd1c8[1]; $sp92257c = explode('_', $sp8bd1c8[2]); $sp8ce264 = array_slice($sp92257c, 1); $sp49181f = implode('_', $sp8ce264); foreach (SPIndicatorsWidgetExtensionsPlotParams::getFieldsCalculationOperations() as $spf4ff42) { $sp044e8f = 'cb:' . $sp07a554 . ':' . $spca87f2 . ':' . $sp49181f . '_' . $spf4ff42; if (in_array($sp044e8f, $spb9703c)) { $sp22f775 = vtranslate($spf04718) . ' - ' . SPIndicatorsWidgetExtensionsPlotParams::translateReportAggregationKey($spf4ff42) . ' "' . vtranslate($spd2e5ec, $spf04718) . '"'; $spbe0322[] = new SPReportCalculationType($sp8a1b1b, $sp044e8f, $sp22f775); } } } } return $spbe0322; } public function getCalculationTypesToFoldersMap() { $sp5e6ed4 = new Vtiger_Paging_Model(); $sp5e6ed4->set('page', 1); $sp5e6ed4->set('limit', 1000); $sp4e9125 = array(); $sp4e9125[vtranslate('All')] = $this->sp49c61f(); foreach (Reports_Folder_Model::getAll() as $sp225aa8) { $sp57ce0d = array(); foreach ($sp225aa8->getReports($sp5e6ed4) as $spf564e7) { $spf564e7 = Reports_Record_Model::getInstanceById($spf564e7->getId()); foreach ($this->sp0db4bf($spf564e7) as $sp0d2978) { $sp57ce0d[] = array('key' => $sp0d2978->getCalculationKey(), 'name' => $sp0d2978->getDisplayName()); } } $sp4e9125[$sp225aa8->getName()] = $sp57ce0d; } return $sp4e9125; } private function sp49c61f() { $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query('SELECT reportid FROM vtiger_report WHERE reporttype=\'summary\' OR reporttype=\'tabular\''); $sp57ce0d = array(); while ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { $spf564e7 = Reports_Record_Model::getInstanceById($sp061318['reportid']); foreach ($this->sp0db4bf($spf564e7) as $sp0d2978) { $sp57ce0d[] = array('key' => $sp0d2978->getCalculationKey(), 'name' => $sp0d2978->getDisplayName()); } } return $sp57ce0d; } private function sp804605($sp7e5365, $spa04cc0) { $spcf7a83 = $this->sp3c7e99($sp7e5365, $spa04cc0); $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->query($spcf7a83); $sp272cce = 0; if ($spda7f19) { $spce6835 = $spe6c55d->fetchByAssoc($spda7f19); $sp272cce = $spce6835['records_count']; } return $sp272cce; } private function sp3c7e99($sp7e5365, $spa04cc0) { $sp20f881 = $sp7e5365->getStdFilterList($sp7e5365->reportid); $sp49c560 = ''; if (isset($sp20f881)) { $sp9e8fde = implode(', ', $sp20f881); } if ($sp9e8fde != '') { $sp49c560 = ' and ' . $sp9e8fde; } $spb66105 = $this->sp1b597e($sp7e5365, $spa04cc0); if (isset($spb66105) && $spb66105 !== false && $spb66105 != '') { $sp49c560 .= ' and ' . $spb66105; } $sp325550 = 'SELECT count(*) AS records_count ' . $sp7e5365->getReportsQuery($sp7e5365->primarymodule, 'COLUMNSTOTOTAL') . ' ' . $sp49c560; $spc78def = array(); preg_match('/&amp;/', $sp325550, $spc78def); if (!empty($spc78def)) { $sp325550 = str_replace('&amp;', '&', $sp325550); $sp325550 = $sp7e5365->replaceSpecialChar($sp325550); } $sp7e5365->queryPlanner->initializeTempTables(); return $sp325550; } private function sp1b597e($sp7e5365, $spa04cc0) { $spb66105 = $sp7e5365->getAdvFilterSql($sp7e5365->reportid); if (isset($spa04cc0) && $spa04cc0 !== false && $spa04cc0 != '') { if ($spb66105 != null) { $spb66105 .= ' and ' . $spa04cc0; } else { $spb66105 = $spa04cc0; } } return $spb66105; } private function sp5dac93($spc2a031) { $sp1aa43a = $spc2a031->get('calculate_expression'); $sp1aa43a = preg_replace_callback('/\\$(.*)\\$/U', array($this, 'replaceIndicatorVariable'), $sp1aa43a); return $sp1aa43a; } public function replaceIndicatorVariable($spc78def) { $sp27eeff = $spc78def[1]; list($sp5127d4, $sp405052) = explode('~', $sp27eeff, 2); $spf564e7 = Reports_Record_Model::getInstanceById($sp5127d4); $sp0f442b = ''; if ($spf564e7->getId() != null) { $sp0f442b = $this->sp732b30($sp5127d4, $sp405052); } return $sp0f442b; } private function sp3aa880($spa04cc0) { $spa42c5b = $this->sp78e2c6(); if (!empty($spa42c5b)) { if ($spa04cc0 == '') { $spa04cc0 = 'vtiger_crmentity.smownerid IN(' . join(',', $spa42c5b) . ')'; } else { $spa04cc0 .= ' AND vtiger_crmentity.smownerid IN(' . join(',', $spa42c5b) . ')'; } } return $spa04cc0; } private function sp78e2c6() { $spa42c5b = array(); $sp8b7435 = $this->indicatorPlotParams->getAssignedUserId(); if ($sp8b7435 !== SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_ASSIGNED_USER_FILTER) { list($sp42382a, $sp1e50e5) = explode(':', $sp8b7435, 2); $this->sp012939($sp42382a, $sp1e50e5, $spa42c5b); } else { $sp61f57a = $this->getCalculateMembers(); foreach ($sp61f57a as $sp42382a => $sp852e14) { foreach ($sp852e14 as $sp1f3907) { $sp1e50e5 = $this->spafa61c($sp1f3907->getId()); $this->sp012939($sp42382a, $sp1e50e5, $spa42c5b); } } } return $spa42c5b; } private function sp012939($sp42382a, $sp1e50e5, &$spa42c5b) { if ($sp1e50e5 != null) { $spa42c5b[] = $sp1e50e5; if ($sp42382a === Settings_Groups_Member_Model::MEMBER_TYPE_GROUPS) { $spdb57a3 = Settings_Groups_Record_Model::getInstance($sp1e50e5); $spa42c5b = array_merge($spa42c5b, array_keys($spdb57a3->getUsersList())); } } } private function spafa61c($sp64a667) { $sp72e355 = explode(':', $sp64a667); if ($sp72e355 && count($sp72e355) > 1) { return $sp72e355[1]; } return null; } private function sp732b30($sp5127d4, $sp405052) { $spf564e7 = Reports_Record_Model::getInstanceById($sp5127d4); $sp7e5365 = ReportRun::getInstance($sp5127d4); $spa04cc0 = $this->sp3aa880($sp7e5365->getAdvFilterSql($spf564e7->getId())); $sp0f442b = $this->sp804605($sp7e5365, $spa04cc0); $sp729184 = $sp7e5365->GenerateReport('TOTALXLS', $this->sp1b597e($sp7e5365, $spa04cc0), true); $spab2b6f = $this->sp3c2434($sp5127d4, $sp405052); $sp20346b = $this->sp3734b7($sp729184, $spab2b6f); if ($sp20346b != null) { $sp0f442b = $sp20346b; } $sp2acbec = Users_Record_Model::getCurrentUserModel(); $sp0f442b = str_replace(decode_html($sp2acbec->get('currency_symbol')), '', $sp0f442b); $sp0f442b = str_replace(decode_html($sp2acbec->get('currency_grouping_separator')), '', $sp0f442b); if ($sp2acbec->get('currency_grouping_separator') == '&nbsp;') { $sp0f442b = str_replace(' ', '', $sp0f442b); } if ($sp2acbec->get('currency_decimal_separator') != '.') { $sp0f442b = str_replace(decode_html($sp2acbec->get('currency_decimal_separator')), '.', $sp0f442b); if ($sp2acbec->get('currency_decimal_separator') == '&nbsp;') { $sp0f442b = str_replace(' ', '.', $sp0f442b); } } return $sp0f442b; } private function sp3734b7($sp729184, $spab2b6f) { $sp0f442b = null; foreach ($sp729184 as $spd2e5ec) { foreach ($spd2e5ec as $specb21e => $sp5abea5) { if ($sp5abea5 != '') { $sp128df8 = explode('_', $specb21e); $spf04718 = $sp128df8[0]; $sp92ea77 = end($sp128df8); $sp4c8fde = join(' ', array_slice($sp128df8, 1, -1)); if ($spab2b6f['moduleName'] == $spf04718 && $spab2b6f['plotByField'] == $sp4c8fde && $spab2b6f['aggregationKey'] == $sp92ea77) { $sp0f442b = $sp5abea5; } } } } return $sp0f442b; } public function getData($spf6f5e4) { $sp4905a8 = array(); $this->indicatorPlotParams = $spf6f5e4; foreach ($this->getIndicatorsList() as $spc2a031) { $sp8420c8 = $this->sp5dac93($spc2a031); $sp345a00 = 0; if ($sp8420c8 != null) { $sp0adabd = new VTExpressionParser(new VTExpressionSpaceFilter(new VTExpressionTokenizer($sp8420c8))); $spaba2de = new VTFieldExpressionEvaluater($sp0adabd->expression()); $sp345a00 = round($spaba2de->evaluate(null), $spc2a031->get('round') == NULL ? 0 : $spc2a031->get('round')); $sp4905a8[] = array('indicatorModel' => $spc2a031, 'label' => $spc2a031->getName(), 'detail' => $spc2a031->get('description'), 'count' => $sp345a00); } } return $this->spd249fc($sp4905a8); } private function spd249fc($sp4905a8) { $spd73187 = true; foreach ($sp4905a8 as $sp5eee0e) { if ($sp5eee0e['count'] != 0) { $spd73187 = false; } } if ($spd73187) { $sp4905a8 = array(); } return $sp4905a8; } private function sp7ec107($sp0f442b) { $sp2acbec = Users_Record_Model::getCurrentUserModel(); $sp0f442b = str_replace($sp2acbec->get('currency_symbol'), '', $sp0f442b); $sp0f442b = str_replace($sp2acbec->get('currency_grouping_separator'), '', $sp0f442b); if ($sp2acbec->get('currency_decimal_separator') != '.') { $sp0f442b = str_replace($sp2acbec->get('currency_decimal_separator'), '.', $sp0f442b); } return (double) $sp0f442b; } private function sp3c2434($sp5127d4, $spc3a548) { $spab2b6f = array(); $spf564e7 = Reports_Record_Model::getInstanceById($sp5127d4); foreach ($spf564e7->getCalculationFields() as $spf04718 => $sp729184) { foreach ($sp729184 as $sp909bb0 => $spd2e5ec) { $sp574a17 = explode(':', $sp909bb0); $sp07a554 = $sp574a17[0]; $spca87f2 = $sp574a17[1]; $sp633acc = explode('_', $sp574a17[2]); $spd2231d = array_slice($sp633acc, 1); $sp49181f = implode('_', $spd2231d); foreach (SPIndicatorsWidgetExtensionsPlotParams::getFieldsCalculationOperations() as $spe214ce) { $sp044e8f = 'cb:' . $sp07a554 . ':' . $spca87f2 . ':' . $sp49181f . '_' . $spe214ce; if ($sp044e8f == $spc3a548) { $sp223892 = explode(':', $spe214ce); $spab2b6f['moduleName'] = $spf04718; $spab2b6f['plotByField'] = $spd2e5ec; $spab2b6f['aggregationKey'] = $sp223892[0]; return $spab2b6f; } } } } return $spab2b6f; } public function getWidgetLinkId() { $spb40b8d = $this->findWidgetLinkModel(); if ($spb40b8d != null) { return $spb40b8d->getId(); } return null; } public function getWidgetReportURL() { return 'index.php?module=' . $this->getModuleName() . '&view=ShowWidget&name=' . $this->getFrontEndWidgetName() . '&record=' . $this->getId(); } protected function getFrontEndWidgetName() { return 'SPIndicatorsWidgetExtensions'; } public function checkDuplicate() { $spe6c55d = PearDatabase::getInstance(); $spd22f8c = $this->getModule(); $spcf7a83 = 'SELECT 1 FROM ' . $spd22f8c->getMainTableName() . ' WHERE name = ?'; $sp4e55db = array($this->getName()); $specf7c8 = $this->getId(); if ($specf7c8 && !$this->get('isDuplicate')) { $spcf7a83 .= ' AND id != ?'; array_push($sp4e55db, $specf7c8); } $spda7f19 = $spe6c55d->pquery($spcf7a83, $sp4e55db); return $spe6c55d->num_rows($spda7f19) > 0; } public static function getCleanInstance($spf04718) { $spc42de6 = Vtiger_Loader::getComponentClassName('Model', 'Record', $spf04718); $spd00410 = new $spc42de6(); $spd00410->setModule($spf04718); return $spd00410; } public function isEditable() { return $this->spd1fd53(); } public function isDeletable() { return $this->spd1fd53(); } public function getBindedWidgetModel() { $sp85fd15 = $this->findWidgetLinkModel(); $sp67375b = new Vtiger_Widget_Model(); if ($sp85fd15 != null) { $sp67375b->setData($this->sp2b9443($sp85fd15)); } return $sp67375b; } private function sp2b9443($sp85fd15) { $spfb188f = array(); $spfb188f['tabid'] = $sp85fd15->tabid; $spfb188f['linkid'] = $sp85fd15->linkid; $spfb188f['linktype'] = $sp85fd15->linktype; $spfb188f['linklabel'] = $sp85fd15->linklabel; $spfb188f['linkurl'] = $sp85fd15->linkurl; $spfb188f['linkicon'] = $sp85fd15->linkicon; $spfb188f['sequence'] = $sp85fd15->sequence; $spfb188f['status'] = $sp85fd15->status; $spfb188f['handler_path'] = $sp85fd15->handler_path; $spfb188f['handler_class'] = $sp85fd15->handler_class; $spfb188f['handler'] = $sp85fd15->handler; return $spfb188f; } public function addWidgetLink() { Vtiger_Link_Model::addLink(getTabid('Home'), SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE, $this->getName(), $this->getWidgetReportURL()); } public function getWidgetLink() { $spee176c = Vtiger_Link_Model::getAllByType(getTabid('Home'), array(SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE)); if (!empty($spee176c[SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE])) { $spac516c = $spee176c[SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE]; foreach ($spac516c as $sp85fd15) { if ($sp85fd15->get('linklabel') == $this->getName() && $sp85fd15->get('linkurl') == $this->getWidgetReportURL()) { return $sp85fd15; } } } return null; } public function updateWidgetlink($sp6460f1) { if ($sp6460f1->getId() != null) { $spe6c55d = PearDatabase::getInstance(); $spe6c55d->pquery('UPDATE vtiger_links SET linklabel=?, linkurl=? WHERE linkid=?', array($this->getName(), $this->getWidgetReportURL(), $sp6460f1->getId())); } } public function removeWidgetLink() { Vtiger_Link_Model::deleteLink(getTabid('Home'), SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE, $this->getName(), $this->getWidgetReportURL()); } public function findWidgetLinkModel() { $spb5617e = getTabid('Home'); $spac516c = Vtiger_Link_Model::getAllByType($spb5617e, array(SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE)); foreach ($spac516c[SPIndicatorsWidgetExtensions_Record_Model::LINKS_DASHBOARD_VIEW_TYPE] as $sp85fd15) { if ($this->sp2ae2a4($sp85fd15)) { return $sp85fd15; } } return null; } private function sp2ae2a4($sp85fd15) { return decode_html($sp85fd15->getLabel()) == decode_html($this->getName()) && decode_html($sp85fd15->getUrl()) == decode_html($this->getWidgetReportURL()); } public function applyReportViewModeToWidget($sp4e5b59) { $sp4e5b59->set('linkurl', $sp4e5b59->get('linkurl') . '&isReportView=true'); } private function spa2f496($spb36ae1, $sp5127d4) { foreach ($spb36ae1 as $sp8a1b1b) { if ($sp8a1b1b->getId() == $sp5127d4) { return true; } } return false; } private function sp8fb7c1() { $sp3909e6 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($this->getId(), $this->getModuleName()); $sp6460f1 = $sp3909e6->getWidgetLink(); if ($sp6460f1 == null) { $this->addWidgetLink(); } else { $this->updateWidgetlink($sp6460f1); } } private function spd1fd53() { $sp2acbec = Users_Record_Model::getCurrentUserModel(); if ($sp2acbec->isAdminUser()) { return true; } $sp4e55db = array($this->get('owner')); $spfd0874 = 'SELECT vtiger_users.id AS id FROM vtiger_users ' . 'INNER JOIN vtiger_user2role ON vtiger_user2role.userid=vtiger_users.id ' . 'INNER JOIN vtiger_role ON vtiger_role.roleid=vtiger_user2role.roleid ' . 'WHERE vtiger_users.status=\'Active\' AND vtiger_users.deleted=0 AND ' . '(vtiger_users.id=?'; $sp474641 = Users_Privileges_Model::getInstanceById($this->get('owner')); $sp0ab0b3 = $sp474641->get('parent_roles'); if (!empty($sp0ab0b3)) { foreach ($sp0ab0b3 as $sp77f2fc => $spda1866) { $sp0ab0b3[$sp77f2fc] = '\'' . $spda1866 . '\''; } $spfd0874 .= ' OR vtiger_role.roleid IN (' . join(',', $sp0ab0b3) . ')'; } $spfd0874 .= ')'; $spe6c55d = PearDatabase::getInstance(); $spda7f19 = $spe6c55d->pquery($spfd0874, $sp4e55db); $sp6526ec = array(); while ($sp061318 = $spe6c55d->fetchByAssoc($spda7f19)) { $sp6526ec[] = $sp061318['id']; } return in_array($sp2acbec->getId(), $sp6526ec); } } class SPIndicatorsWidgetExtensions_Detail_View extends Vtiger_Index_View { public function checkPermission(Vtiger_Request $spe45a8b) { SPIndicatorsWidgetExtensions_Module_Model::checkViewRecordAccess($spe45a8b); } public function preProcess(Vtiger_Request $spe45a8b) { global $default_layout; $sp1de74c = !($default_layout == 'v7'); parent::preProcess($spe45a8b, $sp1de74c); $spf04718 = $spe45a8b->getModule(); $spaa2ece = $spe45a8b->get('record'); $sp89d06e = SPIndicatorsWidgetExtensions_DetailView_Model::getInstance($spf04718, $spe45a8b->get('record')); $spd00410 = $sp89d06e->getRecord(); $spd22f8c = SPIndicatorsWidgetExtensions_Module_Model::getInstance($spf04718); $specf7c8 = SPIndicatorsWidgetExtensions_DetailView_Model::getInstance($spf04718, $spaa2ece); $sp941f86 = array('MODULE' => $spf04718, 'RECORD' => $spaa2ece); $sp981fdc = $specf7c8->getDetailViewLinks($sp941f86); $spedada1 = $this->getViewer($spe45a8b); $sp541e16 = $sp89d06e->getDetailBasicLinks(); $spedada1->assign('MODULE_BASIC_ACTIONS', $sp541e16); $spedada1->assign('DETAILVIEW_LINKS', $sp981fdc); $spedada1->assign('MODULE_MODEL', $spd22f8c); $spedada1->assign('NO_PAGINATION', TRUE); $spedada1->assign('RECORD', $spd00410); $spedada1->assign('MODEL', $spd00410); $spedada1->assign('MODULE', $spf04718); $spedada1->view('DetailHeader.tpl', $spf04718); } function preProcessTplName(Vtiger_Request $spe45a8b) { global $default_layout; if ($default_layout == 'v7') { return 'DetailViewPreProcess.tpl'; } else { return 'IndexViewPreProcess.tpl'; } } public function process(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $specf7c8 = $spe45a8b->get('record'); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); $sp4e5b59 = $spd00410->getBindedWidgetModel(); $spd00410->applyReportViewModeToWidget($sp4e5b59); $spedada1 = $this->getViewer($spe45a8b); $spedada1->assign('WIDGET', $sp4e5b59); $spedada1->assign('MODULE_NAME', $spf04718); $sp59fe15 = Vtiger_RecordStructure_Model::getInstanceFromRecordModel($spd00410, Vtiger_RecordStructure_Model::RECORD_STRUCTURE_MODE_DETAIL); $sp2e9258 = $sp59fe15->getStructure(); $spd22f8c = $spd00410->getModule(); $spedada1->assign('CURRENT_USER_MODEL', Users_Record_Model::getCurrentUserModel()); $spedada1->assign('RECORD_STRUCTURE', $sp2e9258); $spedada1->assign('BLOCK_LIST', $spd22f8c->getBlocks()); $spedada1->view('Detail.tpl', $spf04718); } function getHeaderScripts(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $sp0c9628 = array('~/libraries/jquery/gridster/jquery.gridster.min.js', '~/libraries/jquery/jqplot/jquery.jqplot.js', '~/libraries/jquery/jqplot/plugins/jqplot.canvasTextRenderer.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.categoryAxisRenderer.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.logAxisRenderer.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.pointLabels.min.js', '~/libraries/jquery/jqplot/plugins/jqplot.highlighter.min.js', 'modules.Vtiger.resources.DashBoard', 'modules.Vtiger.resources.dashboards.Widget', "modules.{$spf04718}.resources.Detail"); $sp7322d5 = $this->checkAndConvertJsScripts($sp0c9628); return array_merge(parent::getHeaderScripts($spe45a8b), $sp7322d5); } public function getHeaderCss(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); global $default_layout; $sp8714a9 = array('~/libraries/jquery/jqplot/jquery.jqplot.min.css', "~/layouts/{$default_layout}/modules/{$spf04718}/resources/css/SPIndicatorsWidgetExtensionsDetail.css"); $sp30c216 = $this->checkAndConvertCssStyles($sp8714a9); return array_merge(parent::getHeaderCss($spe45a8b), $sp30c216); } } class SPIndicatorsWidgetExtensions_Edit_View extends Vtiger_Edit_View { public function checkPermission(Vtiger_Request $spe45a8b) { SPIndicatorsWidgetExtensions_Module_Model::checkViewRecordAccess($spe45a8b); } public function preProcess(Vtiger_Request $spe45a8b) { parent::preProcess($spe45a8b); $spf04718 = $spe45a8b->getModule(); $specf7c8 = $spe45a8b->get('record'); $spd00410 = null; if ($specf7c8 != null) { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); } else { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getCleanInstance($spf04718); } $spedada1 = $this->getViewer($spe45a8b); if ($spe45a8b->get('isDuplicate')) { $spedada1->assign('IS_DUPLICATE', true); } $spedada1->assign('MODEL', $spd00410); $spedada1->assign('MODULE', $spf04718); $spedada1->view('EditHeader.tpl', $spf04718); } public function process(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $specf7c8 = $spe45a8b->get('record'); $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getCleanInstance($spf04718); if ($specf7c8 != null) { $spd00410 = SPIndicatorsWidgetExtensions_Record_Model::getInstanceById($specf7c8, $spf04718); } $spedada1 = $this->getViewer($spe45a8b); if ($spe45a8b->get('isDuplicate')) { $spedada1->assign('IS_DUPLICATE', true); $spd00410->set('name', ''); } $spedada1->assign('MODE', ''); if (!empty($specf7c8)) { $spedada1->assign('MODE', 'edit'); } $spc958f4 = Vtiger_RecordStructure_Model::getInstanceFromRecordModel($spd00410, Vtiger_RecordStructure_Model::RECORD_STRUCTURE_MODE_EDIT); $spedada1->assign('RECORD_STRUCTURE_MODEL', $spc958f4); $spedada1->assign('MODEL', $spd00410); $spedada1->assign('RECORD_ID', $specf7c8); $spedada1->assign('INDICATORS_LIST', $spd00410->getIndicatorsList()); $spedada1->assign('REPORTS_CALCULATIONS_TYPES', $spd00410->getCalculationTypesToFoldersMap()); $spedada1->view('Edit.tpl', $spf04718); } public function getHeaderCss(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); global $default_layout; $spf68e1f = array("~/layouts/{$default_layout}/modules/{$spf04718}/resources/css/SPIndicatorsWidgetExtensionsEdit.css"); $sp4a8ab1 = $this->checkAndConvertCssStyles($spf68e1f); return array_merge(parent::getHeaderCss($spe45a8b), $sp4a8ab1); } public function getHeaderScripts(\Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $sp7322d5 = $this->checkAndConvertJsScripts(array("modules.{$spf04718}.resources.Edit")); return array_merge(parent::getHeaderScripts($spe45a8b), $sp7322d5); } } class SPIndicatorsWidgetExtensions_List_View extends Vtiger_Index_View { public function preProcess(Vtiger_Request $spe45a8b, $sp1de74c = true) { parent::preProcess($spe45a8b, false); $spf04718 = $spe45a8b->getModule(); $sp6241bc = SPIndicatorsWidgetExtensions_ListView_Model::getInstance($spf04718); $sp9c4c72 = array('MODULE' => $spf04718, 'ACTION' => $spe45a8b->get('view')); $spedada1 = $this->getViewer($spe45a8b); $spedada1->assign('QUICK_LINKS', $sp6241bc->getSideBarLinks($sp9c4c72)); $this->initializeListViewContents($spe45a8b, $spedada1); $sp771dcc = $spe45a8b->get('viewname'); $spcc501e = $spe45a8b->get('page'); if (empty($spcc501e)) { $spcc501e = '1'; } $sp5e6ed4 = new Vtiger_Paging_Model(); $sp5e6ed4->set('page', $spcc501e); $spedada1->assign('VIEWID', $sp771dcc); $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); $spedada1->assign('MODULE_MODEL', $spd22f8c); if (!$this->listViewHeaders) { $this->listViewHeaders = $sp6241bc->getListViewHeaders(); } if (!$this->listViewEntries) { $this->listViewEntries = $sp6241bc->getListViewEntries($sp5e6ed4); } $sp620205 = count($this->listViewEntries); $spedada1->assign('VIEWID', $sp771dcc); $spedada1->assign('MODULE', $spf04718); $spedada1->assign('LISTVIEW_ENTRIES_COUNT', $sp620205); $spedada1->assign('LISTVIEW_HEADERS', $this->listViewHeaders); $spedada1->assign('LISTVIEW_ENTRIES', $this->listViewEntries); $spedada1->assign('PAGING_MODEL', $sp5e6ed4); if (!$this->listViewLinks) { $this->listViewLinks = $sp6241bc->getListViewLinks($sp9c4c72); } $spedada1->assign('LISTVIEW_LINKS', $this->listViewLinks); $sp541e16 = $sp6241bc->getListBasicLinks(); foreach ($sp541e16 as $spc79722) { $sp1d077d[] = $spc79722; } $spedada1->assign('MODULE_BASIC_ACTIONS', $sp1d077d); if ($sp1de74c) { $this->preProcessDisplay($spe45a8b); } } public function preProcessTplName(Vtiger_Request $spe45a8b) { return 'ListViewPreProcess.tpl'; } public function process(Vtiger_Request $spe45a8b) { $spedada1 = $this->getViewer($spe45a8b); $spf04718 = $spe45a8b->getModule(); $spd22f8c = Vtiger_Module_Model::getInstance($spf04718); $this->initializeListViewContents($spe45a8b, $spedada1); $this->assignCustomViews($spe45a8b, $spedada1); $spedada1->assign('VIEW', $spe45a8b->get('view')); $spedada1->assign('MODULE_MODEL', $spd22f8c); $spedada1->assign('CURRENT_USER_MODEL', Users_Record_Model::getCurrentUserModel()); $spedada1->view('ListViewContents.tpl', $spf04718); } public function postProcess(Vtiger_Request $spe45a8b) { $spedada1 = $this->getViewer($spe45a8b); $spf04718 = $spe45a8b->getModule(); $spedada1->view('ListViewPostProcess.tpl', $spf04718); parent::postProcess($spe45a8b); } public function initializeListViewContents(Vtiger_Request $spe45a8b, Vtiger_Viewer $spedada1) { $spf04718 = $spe45a8b->getModule(); $sp771dcc = $spe45a8b->get('viewname'); $spcc501e = $spe45a8b->get('page'); $sp114a15 = $spe45a8b->get('orderby'); $spd41ab7 = $spe45a8b->get('sortorder'); if ($spd41ab7 == 'ASC') { $sp4dc7a1 = 'DESC'; $sp59a276 = 'icon-chevron-down'; } else { $sp4dc7a1 = 'ASC'; $sp59a276 = 'icon-chevron-up'; } $sp6241bc = SPIndicatorsWidgetExtensions_ListView_Model::getInstance($spf04718); $sp9c4c72 = array('MODULE' => $spf04718, 'ACTION' => $spe45a8b->get('view'), 'CVID' => $sp771dcc); $spf81ddc = $sp6241bc->getListViewMassActions($sp9c4c72); if (!empty($sp114a15)) { $sp6241bc->set('orderby', $sp114a15); $sp6241bc->set('sortorder', $spd41ab7); } $sp28e428 = $spe45a8b->get('search_key'); $spdec572 = $spe45a8b->get('search_value'); $sp87f499 = $spe45a8b->get('operator'); if (!empty($sp87f499)) { $sp6241bc->set('operator', $sp87f499); $spedada1->assign('OPERATOR', $sp87f499); $spedada1->assign('ALPHABET_VALUE', $spdec572); } if (!empty($sp28e428) && !empty($spdec572)) { $sp6241bc->set('search_key', $sp28e428); $sp6241bc->set('search_value', $spdec572); } $spedada1->assign('LISTVIEW_MASSACTIONS', $spf81ddc['LISTVIEWMASSACTION']); $spedada1->assign('PAGE_NUMBER', $spcc501e); $spedada1->assign('ORDER_BY', $sp114a15); $spedada1->assign('SORT_ORDER', $spd41ab7); $spedada1->assign('NEXT_SORT_ORDER', $sp4dc7a1); $spedada1->assign('SORT_IMAGE', $sp59a276); $spedada1->assign('COLUMN_NAME', $sp114a15); if (PerformancePrefs::getBoolean('LISTVIEW_COMPUTE_PAGE_COUNT', false)) { if (!$this->listViewCount) { $this->listViewCount = $sp6241bc->getListViewCount(); } $spedada1->assign('LISTVIEW_COUNT', $this->listViewCount); } $spedada1->assign('IS_MODULE_EDITABLE', $sp6241bc->getModule()->isPermitted('EditView')); $spedada1->assign('IS_MODULE_DELETABLE', $sp6241bc->getModule()->isPermitted('Delete')); } public function getRecordsCount(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $sp652531 = $this->getListViewCount($spe45a8b); $spda7f19 = array(); $spda7f19['module'] = $spf04718; $spda7f19['count'] = $sp652531; $sp9f77c8 = new Vtiger_Response(); $sp9f77c8->setEmitType(Vtiger_Response::$EMIT_JSON); $sp9f77c8->setResult($spda7f19); $sp9f77c8->emit(); } public function getListViewCount(Vtiger_Request $spe45a8b) { $spf04718 = $spe45a8b->getModule(); $sp28e428 = $spe45a8b->get('search_key'); $spdec572 = $spe45a8b->get('search_value'); $sp6241bc = SPIndicatorsWidgetExtensions_ListView_Model::getInstance($spf04718); $sp6241bc->set('search_key', $sp28e428); $sp6241bc->set('search_value', $spdec572); $sp6241bc->set('operator', $spe45a8b->get('operator')); return $sp6241bc->getListViewCount(); } public function getPageCount(Vtiger_Request $spe45a8b) { $sp461918 = $this->getListViewCount($spe45a8b); $sp5e6ed4 = new Vtiger_Paging_Model(); $sp163a3b = $sp5e6ed4->getPageLimit(); $spf59a62 = ceil((int) $sp461918 / (int) $sp163a3b); $spda7f19 = array(); $spda7f19['page'] = $spf59a62; $spda7f19['numberOfRecords'] = $sp461918; $sp9f77c8 = new Vtiger_Response(); $sp9f77c8->setResult($spda7f19); $sp9f77c8->emit(); } function getHeaderScripts(Vtiger_Request $spe45a8b) { $sp29b3db = parent::getHeaderScripts($spe45a8b); $sp0c9628 = array('modules.Vtiger.resources.List'); $sp7322d5 = $this->checkAndConvertJsScripts($sp0c9628); return array_merge($sp29b3db, $sp7322d5); } public function assignCustomViews($spe45a8b, $spedada1) { $spf92d97 = CustomView_Record_Model::getAllByGroup($spe45a8b->getModule()); if (!empty($spf92d97)) { $spedada1->assign('CUSTOM_VIEWS', $spf92d97); $spef752e = $spedada1->get_template_vars('VIEWID'); $sp831dc4 = new CustomView_Record_Model(); $spedada1->assign('CURRENT_CV_MODEL', $sp831dc4); } } } class SPIndicatorsWidgetExtensions_ListAjax_View extends SPIndicatorsWidgetExtensions_List_View { function __construct() { parent::__construct(); $this->exposeMethod('getRecordsCount'); $this->exposeMethod('getPageCount'); } function preProcess(Vtiger_Request $spe45a8b) { return true; } function postProcess(Vtiger_Request $spe45a8b) { return true; } function process(Vtiger_Request $spe45a8b) { $spe1a6f3 = $spe45a8b->get('mode'); if (!empty($spe1a6f3)) { $this->invokeExposedMethod($spe1a6f3, $spe45a8b); return; } } } class SPIndicatorsWidgetExtensionsPlotParams { const DEFAULT_PLOT_BY = 'count'; const SUM_PLOT_BY = 'sum'; const AVERAGE_PLOT_BY = 'average'; const MAX_PLOT_BY = 'max'; const MIN_PLOT_BY = 'min'; const DEFAULT_ASSIGNED_USER_FILTER = 'all'; private static $fieldsCalculationOperations = array('SUM:2', 'AVG:3', 'MIN:4', 'MAX:5'); private static $reportAggregateLabelsMap = array('count' => 'count', 'sum' => 'LBL_SUM', 'average' => 'LBL_AVG', 'max' => 'LBL_MAX', 'min' => 'LBL_MIN'); private static $reportsAggregationKeysMapping = array('count' => 'LBL_RECORD_COUNT', 'SUM:2' => 'LBL_SUM_VALUE', 'AVG:3' => 'LBL_AVERAGE', 'MIN:4' => 'LBL_LOWEST_VALUE', 'MAX:5' => 'LBL_HIGHEST_VALUE'); private static $plotTypesMap = array(SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_PLOT_BY => 'LBL_RECORD_COUNT', SPIndicatorsWidgetExtensionsPlotParams::SUM_PLOT_BY => 'LBL_SUM_VALUE', SPIndicatorsWidgetExtensionsPlotParams::AVERAGE_PLOT_BY => 'LBL_AVERAGE', SPIndicatorsWidgetExtensionsPlotParams::MAX_PLOT_BY => 'LBL_HIGHEST_VALUE', SPIndicatorsWidgetExtensionsPlotParams::MIN_PLOT_BY => 'LBL_LOWEST_VALUE'); private $assignedUserId; public function __construct() { $this->assignedUserId = SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_ASSIGNED_USER_FILTER; } public function parsePlotParams($spe45a8b) { $this->assignedUserId = $spe45a8b->get('assigned_user_id', SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_ASSIGNED_USER_FILTER); } public function getAssignedUserId() { return $this->assignedUserId; } public static function getFieldsCalculationOperations() { return self::$fieldsCalculationOperations; } public static function getTranslatedPlotParamName($sp3efcd4) { if (array_key_exists($sp3efcd4, self::$plotTypesMap)) { $sp3efcd4 = vtranslate(self::$plotTypesMap[$sp3efcd4], 'Reports'); } return $sp3efcd4; } public static function getPlotTypesMap() { $sp757d9e = array(); foreach (self::$plotTypesMap as $sp6c5a37 => $sp979126) { $sp757d9e[$sp6c5a37] = vtranslate($sp979126, 'Reports'); } return $sp757d9e; } public function getCurrentPlotParamAggregateLabel() { if (array_key_exists($this->plotBy, self::$reportAggregateLabelsMap)) { return self::$reportAggregateLabelsMap[$this->plotBy]; } return self::$reportAggregateLabelsMap[SPIndicatorsWidgetExtensionsPlotParams::DEFAULT_PLOT_BY]; } public static function translateReportAggregationKey($sp92ea77) { return vtranslate(self::$reportsAggregationKeysMapping[$sp92ea77], 'Reports'); } } class SPIndicatorModel extends Vtiger_Base_Model { public function getName() { return $this->get('name'); } public function getIndicatorInfo() { return $this->valueMap; } } class SPReportCalculationType { private $report; private $fieldCalculationValue; private $fieldDisplayName; public function __construct($sp8a1b1b, $sp044e8f, $sp22f775) { $this->report = $sp8a1b1b; $this->fieldCalculationValue = $sp044e8f; $this->fieldDisplayName = $sp22f775; } public function getReport() { return $this->report; } public function getDisplayName() { return $this->report->getName() . ': ' . $this->fieldDisplayName; } public function getFieldCalculationValue() { return $this->fieldCalculationValue; } public function getCalculationKey() { return $this->getReport()->getId() . '~' . $this->getFieldCalculationValue(); } }